<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Libra | 내정보</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/common/header-footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
</head>
<body>
  {% include 'common/header.html' %}

  <div class="login-container" style="max-width: 720px;">
    <h2>내 정보</h2>

    <!-- 기본 회원정보: 읽기 전용 -->
    <div>
      <label>아이디</label>
      <input type="text" value="{{ user.usr_id }}" disabled />
      <label>이름</label>
      <input type="text" value="{{ user.usr_name }}" disabled />
      <label>이메일</label>
      <input type="text" value="{{ user.usr_email }}" disabled />
      <label>소속대학</label>
      <input type="text" value="{{ user.usr_snm }}" disabled />
    </div>

    <div style="margin-top:10px;">
      <a href="{{ url_for('edit_profile') }}"><button type="button">회원정보 수정</button></a>
      <!-- edit_profile 라우트는 나중에 구현 예정 -->
    </div>

    <hr style="margin:20px 0;">

    <!-- 학년별 입력 박스 -->
    <h3>학년별 학습 데이터 입력</h3>
    <p style="margin-top:-8px;">숫자만 입력 (연도, 자료구입비(CPS), 대출건수(LPS), 방문수(VPS))</p>

    <form id="academic-form">
      <!-- 1학년 -->
      <fieldset style="margin-top:15px;">
        <legend>1학년</legend>
        <label for="first_yr">이수연도</label>
        <input id="first_yr" type="number" value="{{ user.y1 or '' }}">
        <label for="first_cps">자료구입비(CPS)</label>
        <input id="first_cps" type="number" step="any" value="{{ user.cps1 or '' }}">
        <label for="first_lps">대출건수(LPS)</label>
        <input id="first_lps" type="number" step="any" value="{{ user.lps1 or '' }}">
        <label for="first_vps">방문수(VPS)</label>
        <input id="first_vps" type="number" step="any" value="{{ user.vps1 or '' }}">
      </fieldset>

      <!-- 2학년 -->
      <fieldset style="margin-top:15px;">
        <legend>2학년</legend>
        <label for="second_yr">이수연도</label>
        <input id="second_yr" type="number" value="{{ user.y2 or '' }}">
        <label for="second_cps">자료구입비(CPS)</label>
        <input id="second_cps" type="number" step="any" value="{{ user.cps2 or '' }}">
        <label for="second_lps">대출건수(LPS)</label>
        <input id="second_lps" type="number" step="any" value="{{ user.lps2 or '' }}">
        <label for="second_vps">방문수(VPS)</label>
        <input id="second_vps" type="number" step="any" value="{{ user.vps2 or '' }}">
      </fieldset>

      <!-- 3학년 -->
      <fieldset style="margin-top:15px;">
        <legend>3학년</legend>
        <label for="third_yr">이수연도</label>
        <input id="third_yr" type="number" value="{{ user.y3 or '' }}">
        <label for="third_cps">자료구입비(CPS)</label>
        <input id="third_cps" type="number" step="any" value="{{ user.cps3 or '' }}">
        <label for="third_lps">대출건수(LPS)</label>
        <input id="third_lps" type="number" step="any" value="{{ user.lps3 or '' }}">
        <label for="third_vps">방문수(VPS)</label>
        <input id="third_vps" type="number" step="any" value="{{ user.vps3 or '' }}">
      </fieldset>

      <!-- 4학년 -->
      <fieldset style="margin-top:15px;">
        <legend>4학년</legend>
        <label for="fourth_yr">이수연도</label>
        <input id="fourth_yr" type="number" value="{{ user.y4 or '' }}">
        <label for="fourth_cps">자료구입비(CPS)</label>
        <input id="fourth_cps" type="number" step="any" value="{{ user.cps4 or '' }}">
        <label for="fourth_lps">대출건수(LPS)</label>
        <input id="fourth_lps" type="number" step="any" value="{{ user.lps4 or '' }}">
        <label for="fourth_vps">방문수(VPS)</label>
        <input id="fourth_vps" type="number" step="any" value="{{ user.vps4 or '' }}">
      </fieldset>

      <button type="submit" style="margin-top:16px;">저장하기</button>
    </form>
  </div>

  {% include 'common/footer.html' %}

  <script>
  (function(){
    const form = document.getElementById('academic-form');

    function valOrNull(id){
      const v = document.getElementById(id).value.trim();
      return v === '' ? null : Number(v);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!confirm('입력한 내용을 저장하겠습니까?')) return;

      const payload = {
        '1ST_YR':      valOrNull('first_yr'),
        '1ST_USR_CPS': valOrNull('first_cps'),
        '1ST_USR_LPS': valOrNull('first_lps'),
        '1ST_USR_VPS': valOrNull('first_vps'),
        '2ND_YR':      valOrNull('second_yr'),
        '2ND_USR_CPS': valOrNull('second_cps'),
        '2ND_USR_LPS': valOrNull('second_lps'),
        '2ND_USR_VPS': valOrNull('second_vps'),
        '3RD_YR':      valOrNull('third_yr'),
        '3RD_USR_CPS': valOrNull('third_cps'),
        '3RD_USR_LPS': valOrNull('third_lps'),
        '3RD_USR_VPS': valOrNull('third_vps'),
        '4TH_YR':      valOrNull('fourth_yr'),
        '4TH_USR_CPS': valOrNull('fourth_cps'),
        '4TH_USR_LPS': valOrNull('fourth_lps'),
        '4TH_USR_VPS': valOrNull('fourth_vps')
        // SCR_EST_* 는 추후 예측값 저장 시 사용
      };

      try{
        const res = await fetch('/api/user/academic', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
          alert('저장이 완료되었습니다.');
          location.reload();
        } else {
          alert(data.error || '저장 중 오류가 발생했습니다.');
        }
      }catch(err){
        alert('네트워크 오류가 발생했습니다.');
      }
    });
  })();
  </script>
</body>
</html>

<!--services/web_frontend/templates/chartpage2.html-->

{% extends "common/base.html" %}

{% block title %}Libra - 환경점수 예측 분석{% endblock %}

{% block head_extra %}
  <!-- 페이지 전용 CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/common/header.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chartpage.css') }}">
  <!-- Chart.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="main-layout">
    <!-- 왼쪽 컨트롤 패널 -->
    <aside class="control-panel">
      <div class="panel-section">
        <h3>📊 데이터 설정</h3>

        <div class="form-group">
          <label>연도 범위</label>
          <div class="year-range-slider">
            <div class="slider-container">
              <button class="arrow-btn" onclick="adjustYearRange('start', -1)">◀</button>
              <input type="range" id="yearStartSlider" class="range-slider" min="0" max="0" value="0" onchange="onYearSliderChange()">
              <button class="arrow-btn" onclick="adjustYearRange('start', 1)">▶</button>
              <span>~</span>
              <button class="arrow-btn" onclick="adjustYearRange('end', -1)">◀</button>
              <input type="range" id="yearEndSlider" class="range-slider" min="0" max="0" value="0" onchange="onYearSliderChange()">
              <button class="arrow-btn" onclick="adjustYearRange('end', 1)">▶</button>
            </div>
            <div class="range-labels">
              <span id="minYearLabel">-</span>
              <span id="maxYearLabel">-</span>
            </div>
            <div class="selected-range" id="selectedYearRange">전체</div>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="showAverageCheckbox" checked onchange="onShowAverageChange()" style="margin-right: 8px;">
            평균값 그래프 표시
          </label>
        </div>
      </div>

      <div class="panel-section">
        <h3>🔍 필터 선택</h3>

        <div class="form-group">
          <label for="stypFilter">대학유형</label>
          <select id="stypFilter" onchange="onFilterChange()">
            <option value="전체">전체</option>
          </select>
        </div>

        <div class="form-group">
          <label for="fndFilter">설립</label>
          <select id="fndFilter" onchange="onFilterChange()">
            <option value="전체">전체</option>
          </select>
        </div>

        <div class="form-group">
          <label for="rgnFilter">지역</label>
          <select id="rgnFilter" onchange="onFilterChange()">
            <option value="전체">전체</option>
          </select>
        </div>

        <div class="form-group">
          <label for="uscFilter">규모</label>
          <select id="uscFilter" onchange="onFilterChange()">
            <option value="전체">전체</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <h3>🏫 대학 선택</h3>
        <div class="selection-mode">
          <button class="mode-btn active" onclick="setSelectionMode('all')">필터링 후 전체</button>
          <button class="mode-btn" onclick="setSelectionMode('manual')">수동 선택</button>
        </div>

        <!-- 데이터 출력 범위 슬라이더 -->
        <div class="form-group" id="dataRangeSliderGroup">
          <label>출력 범위 (이름순 정렬)</label>
          <div class="data-count-info" id="dataCountInfo">필터링된 데이터: 0개</div>
          <div class="data-range-slider">
            <div class="slider-container">
              <button class="arrow-btn" onclick="adjustDataRange('start', -1)">◀</button>
              <input type="range" id="dataStartSlider" class="range-slider" min="1" max="1" value="1" onchange="onDataSliderChange()">
              <button class="arrow-btn" onclick="adjustDataRange('start', 1)">▶</button>
              <span>~</span>
              <button class="arrow-btn" onclick="adjustDataRange('end', -1)">◀</button>
              <input type="range" id="dataEndSlider" class="range-slider" min="1" max="1" value="1" onchange="onDataSliderChange()">
              <button class="arrow-btn" onclick="adjustDataRange('end', 1)">▶</button>
            </div>
            <div class="range-labels">
              <span id="dataMinLabel">1</span>
              <span id="dataMaxLabel">1</span>
            </div>
            <div class="selected-range" id="selectedDataRange">전체</div>
          </div>
        </div>

        <div class="university-selector" id="universitySelector">
          <div class="select-all-container">
            <button class="select-all-btn" onclick="toggleAllUniversities()">전체 선택/해제</button>
            <span class="selected-count" id="selectedCount">0개 선택됨</span>
          </div>
          <div id="universityList">
            <!-- 동적으로 생성됨 -->
          </div>
        </div>

        <button class="generate-btn" onclick="generateChart()">차트 생성</button>
      </div>

      <div class="panel-actions">
        <button class="action-btn primary" onclick="exportCharts()">차트 내보내기</button>
        <button class="action-btn secondary" onclick="saveAnalysis()">분석 저장</button>
      </div>
    </aside>

    <!-- 오른쪽 차트 영역 -->
    <section class="chart-area">
      <div class="chart-header">
        <h2>환경점수 예측 분석</h2>
      </div>

        <!-- 그래프 2컬럼 레이아웃 -->
        <div class="chart-grid chart-grid--two-col">
          <!-- 왼쪽: 연도별 점수 추이 차트 -->
          <div class="chart-box">
            <h4>연도별 환경점수 추이</h4>
            <div class="single-chart-container trend-chart-container">
              <canvas id="trendChart"></canvas>
            </div>
          </div>

          <!-- 오른쪽: 상승/하락 비율 차트 -->
          <div class="chart-box">
            <h4>최근 추세 분석</h4>
            <div class="single-chart-container">
              <canvas id="trendPieChart"></canvas>
            </div>
            <div class="trend-stats">
              <div class="stat-item">
                <div class="stat-label">상승 추세</div>
                <div class="stat-value positive" id="upwardPercent">-</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">하락 추세</div>
                <div class="stat-value negative" id="downwardPercent">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-loading" id="chartLoading" style="display: none;">
          <div class="loading-spinner"></div>
          <p>차트를 생성하고 있습니다...</p>
        </div>

        <div class="chart-placeholder" id="chartPlaceholder">
          <div class="placeholder-content">
            <div class="placeholder-icon">📈</div>
            <h3>환경점수 예측 차트가 표시될 영역입니다</h3>
            <p>연도 범위와 필터를 설정한 후 '차트 생성' 버튼을 클릭하세요.</p>
          </div>
        </div>
      </div>

      <div class="chart-info">
        <div class="info-card">
          <h4>현재 분석 정보</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">연도 범위:</span>
              <span class="value" id="currentYearRange">-</span>
            </div>
            <div class="info-item">
              <span class="label">대학유형:</span>
              <span class="value" id="currentStyp">전체</span>
            </div>
            <div class="info-item">
              <span class="label">설립:</span>
              <span class="value" id="currentFnd">전체</span>
            </div>
            <div class="info-item">
              <span class="label">지역:</span>
              <span class="value" id="currentRgn">전체</span>
            </div>
            <div class="info-item">
              <span class="label">규모:</span>
              <span class="value" id="currentUsc">전체</span>
            </div>
            <div class="info-item">
              <span class="label">선택 모드:</span>
              <span class="value" id="currentSelectionMode">필터링 후 전체</span>
            </div>
            <div class="info-item">
              <span class="label">분석 대학 수:</span>
              <span class="value" id="dataCount">-</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- 필터바 스크롤 기능 -->
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const sc = document.getElementById('filterScroll');
      document.getElementById('fltPrev')?.addEventListener('click', () => sc?.scrollBy({ left: -200, behavior: 'smooth' }));
      document.getElementById('fltNext')?.addEventListener('click', () => sc?.scrollBy({ left:  200, behavior: 'smooth' }));
    });
  </script>

  <!-- 페이지 전용 JS -->
  <script src="{{ url_for('static', filename='js/chartpage2.js') }}" defer></script>
{% endblock %}